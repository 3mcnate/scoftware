# AI Coding Best Practices

## Architecture

This project uses Next.js and Supabase, including Supabase Auth. The first choice for data fetching should be on the browser, using Tanstack Query wrapped by the @supabase-cache-helpers/postgrest-react-query library. 

### Tech Stack

- TypeScript 
- Next.js 16 deployed on Vercel's serverless platform
	- pages in the (public) route group should use Incremental Static Regeneration (ISR)
	- pages in the (protected) route group are dashboard pages and should generally fetch data using Client Side Rendering (CSR)
	- pages in the (auth) route group can be statically generated
- Shadcn/ui components styled with TailwindCSS
- Tanstack Query (React Query) for data fetching on the frontend
- Drizzle ORM for privileged DB operations server-side
- Supabase with RLS policies for direct browser to DB CRUD operations. Not all tables have RLS rules - some will only be accessed via authenticated server routes and Drizzle. Examples of such tables include those relating to checkout, stripe webhooks, and anywhere it would be too complicated to enforce security with RLS policies
- React-hook-form for frontend forms
- Zod for server route validation and forms (import { z } 'zod/v4')
- Stripe integration for payments
- Resend for emails

### Project Directory Structure

src/
├── app/                            # Next.js routes (App Router)
│   ├── (auth)/               		# pages for login, signup, forgot password, etc
│   ├── (protected)/                # Authenticated-only pages
│   │	├── participant/            # Participant portal pages
│   │	├── guide/                  # Guide dashboard pages
│   │	└── admin/                  # Admin guides dashboard pages
│   │
│   ├── (public)/					# Public trip pages, users click through and sign up for trips 
│	│	│							# everything in this folder should be rendered with ISR
│   │	├── trips/                  	# Displays list of published upcoming trips
│   │	├── past-trips/             	# Displays list of past trips 
│   │	└── trip/[tripId]/page.tsx      # Trip details page
│   │
│   ├── api/                        # API routes when needed for functionality (e.g. Stripe webhooks, managing checkout, etc)
│   ├── layout.tsx
│   └── page.tsx
│
├── components/                     # Components with some global scope (e.g. not specific to a feature)
│   ├── ui/							# shadcn components
│   │   ├── button.tsx
│   │   ├── card.tsx
│   │   ├── modal.tsx
│   │   └── ...
│   │
│	├── nav/						# navbars
│   └── providers/					# context providers for Tanstack Query, Theme, Auth, Toaster, etc
│   
├── hooks/                          # React hooks with global scope (not specific to a feature)
│   ├── use-auth.ts
│   └── use-toast.ts
│
├── features/                     # Domain-based feature folders
│   ├── trips/
│   │   ├── hooks/                # UI/page hooks (e.g. useTripForm, useTripEditor)
│   │   ├── components/           # Trip-specific UI components
│   │   ├── types.ts
│   │
│   └── users/
│       ├── hooks/
│       ├── components/
│       └── ...
│
├── data/                          # feature-based data access (React Query + fetchers)
│   ├── trips/
│   │   ├── get-trips.ts           # exports: getTrips(), useTrips()
│   │   ├── get-trip-by-id.ts      # exports: getTripById(), useTripById()
│   │   ├── update-trip.ts         # exports: updateTrip(), useUpdateTrip()
│   │
│   ├── users/
│   │   ├── get-user.ts
│   │   ├── get-users.ts
│   │   ├── update-user.ts
│   │
│   └── budgets/
│       ├── get-budgets.ts
│       └── use-budget-summary.ts
│
├── utils/                          # General utilities
│   ├── supabase/ 		            
│   │	├── client.ts         		# Supabase browser client
│   │	├── middleware.ts           # Session refresh middleware
│   │	└── server.ts          		# Supabase server client
│   │
│   ├── drizzle.ts           		# Drizzle DB client
│   ├── cn.ts                    	# tailwind merge utility
│   └── ... 						# other utility files
│
├── drizzle/                        # Database schema + migrations. Note: Drizzle migrations aren't used. 
│   ├── migrations/
│   ├── schema.ts
│   ├── auth-schema.ts
│   └── relations.ts
│
├── supabase/
│	├── migrations/         # SQL migration files generated by Supabase CLI
│	│   ├── 20251029060307_basic_tables.sql
│	│   ├── 20251030051132_ticket_tracking_columns.sql
│	│   └── ...
│   │
│	├── seeds/              # Seed scripts for development data
│	│   └── auth_trigger.sql
│   │
│	├── pg_functions/       # Postgres functions (NOT supabase edge functions)
│	│   ├── enforce_times.sql
│	│   ├── handle_new_user.sql
│	│   ├── authorize.sql
│	│   └── ...
│	│       
│	└── supabase.toml       # Supabase project configuration
│
└── types/							# global types
    └── database.types.ts  			# contains all TypeScript types generated from the Supabase database 

### Frontend Instructions

- Use shadcn/ui components. Use the #shadcn MCP tool to look up documentation and which component is best for each use case. Make simple yet beautiful and performant designs.  
- Every input, variable, and return value must have explicit types.
- Use the supabase-js client when possible for crud operations. Always wrap calls with the @supabase-cache-helpers/postgrest-react-query library.
- Use react-hook-form and the shadcn/ui <Form> component with zod for form management.

### Backend (Next.js API)

- Don’t wrap every route in try/catch. Let Next.js handle 500 responses.
- Only catch errors you intend to handle (e.g. user-facing validation).

## Other Patterns and Instructions:

### Type Safety

- Always prefer type safety over defensive programming. Let type systems and schema validation ensure correctness. Don't use the "any" type unless absolutely necessary
- For DB interactions, import/derive types from Tables, Enums, and Views in types/database.types.ts (e.g. Table<'trips'>). This keeps in sync with our supabase database. Also, you can use the Supabase MCP server to inspect the schema of the database.
- Don’t guess object shapes. Import or derive types from existing definitions.

### General Code Quality

- Keep files small and scoped and code clean and modular. Break large components into helpers, sub-components, and separate files. avoid bloated logic in components. Factor out hooks and shared utils.
- Prioritize concise, clean, readable, and reusable patterns, without unnecessary abstractions or code spaghetti.
- Reuse shared logic instead of duplicating.
- Minimize comments. Only add them for non-obvious logic.
- No emojis.
- No excessive logging.
- Use Promise.all() for parallel requests where interdependencies don’t exist.
- Follow the Project Directory Structure defined above. Do not invent ad-hoc structures.
- If there is a high-quality third-party package that could achieve what you're trying to do easier, suggest it.
- Never guess. If you are unclear where something exists in the codebase (files, functions, types, endpoints), ask or search. Do not assume or invent. Always locate the source of truth before proceeding.
- Design for extensibility, but don’t over-engineer.
- If you are confused on what has been asked of you then ask clarifying questions. Don't assume if you're unsure.
